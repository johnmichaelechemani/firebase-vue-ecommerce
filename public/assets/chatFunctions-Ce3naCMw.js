import{u as b,G as D,H as w,J as E,j as p,m as _,K as J,L as I,M as v,N,O as y,P as O,Q as F,S,U as L}from"./index-Ce3yGuet.js";const{user:Q,auth:U}=b(),m=(i,e)=>[i,e].sort().join("_");new Promise(i=>{const e=D(U,d=>{Q.value=d,e(),i()})});const l=w(),o=E.value.userId,n=p([]),j=p({}),x=()=>{const i=a=>{h(a)},e=p(""),d=async a=>{const s=m(o,a),g={id:`temp_${Date.now()}`,senderId:o,recipientId:a,message:e.value,isSending:!0,timestamp:new Date};n.value.push(g);try{await J(I(l,`chats/${s}`),{participants:{[o]:!0,[a]:!0},lastMessage:e.value,sender:o,reciever:a,timestamp:v()},{merge:!0});const c=await N(y(l,`chats/${s}/messages`),{senderId:o,recipientId:a,message:e.value,timestamp:v()});n.value=n.value.map(u=>u.id===g.id?{...u,id:c.id,isSending:!1}:u),localStorage.setItem(`messages_${s}`,JSON.stringify(n.value)),e.value=""}catch(c){console.error("Firebase message send error:",c)}finally{e.value=""}},h=a=>{try{const s=m(o,a),g=localStorage.getItem(`messages_${s}`);n.value=g?JSON.parse(g):[];const c=O(y(l,`chats/${s}/messages`),F("timestamp","asc")),u=I(l,"chats",s),f=S(u,r=>{if(r.exists()){const t=r.data();t&&t.lastMessage&&(j.value[s]=t.lastMessage)}}),$=S(c,r=>{try{const t=r.docs.map(M=>({id:M.id,...M.data()}));n.value=t,localStorage.setItem(`messages_${s}`,JSON.stringify(t))}catch(t){console.error("❌ Message Mapping Error:",{error:t.message,snapshot:r.docs})}},r=>{console.error("❌ Snapshot Listener Error:",{error:r.message,query:c})});L(()=>{$(),f()})}catch(s){console.error("❌ General Messages Loading Error:",{error:s.message,userId:o,receiverId:a})}};return _(()=>{h()}),{sendMessage:d,messages:n,message:e,selectedMall:i,getChatId:m}};export{x as c,m as g,j as l,n as m};
